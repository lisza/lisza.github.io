<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>a poem</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <link rel="stylesheet" type="text/css" href="css/style.css">
    <style>
      .splash {
        margin: 50px;
      }
    </style>
  </head>

  <body>
    <div class="splash">
      <div class="title"></div>
      <div class="author"></div>
      <h1><div class="lines"></div></h1>
    </div>

    <script>
      const poemTitle = document.querySelector('.title');
      const poemAuthor = document.querySelector('.author');
      const poemLines = document.querySelector('.lines');
      const titleIndex = getRandomInt(0, 2973)

      // get random integer between 0-2997, the length of the titles
      // array in poetrybd.org
      function getRandomInt(min, max) {
        min = Math.ceil(min);
        max = Math.floor(max);
        return Math.floor(Math.random() * (max - min)) + min; //The maximum is exclusive and the minimum is inclusive
      }

      // Hacky fix: Use a CORS proxy to get around localhost
      // “No Access-Control-Allow-Origin header” problem :/
      // https://stackoverflow.com/questions/43871637/no-access-control-allow-origin-header-is-present-on-the-requested-resource-whe/43881141
      const proxyurl = "https://cors-anywhere.herokuapp.com/";

      // get a random title from poetrydb.org using a random integer (titleIndex)
      fetch(proxyurl + 'http://poetrydb.org/title')
        .then(function(response) {
          return response.json();
        })
        .then(function(data) {
          const title = data.titles[titleIndex];
          console.log(title);
          getPoem(title);
        })

      // get poem data for a title through poetrydb.org
      function getPoem(title) {
        fetch(`${proxyurl}http://poetrydb.org/title/${title}`)
          .then(function(response) {
            return response.json();
          })
          .then(function(data) {
            displayPoem(data[0]);
          })
      }

      function displayPoem({title, author, lines}) {
        // console.log(title, author);
        // console.log(lines);
        poemTitle.textContent = title;
        poemAuthor.textContent = author;

        // create array of poem words with line breaks at the end of each line
        let poemContent = []
        lines.forEach(line => {
          line = line.split(' ');
          poemContent = poemContent.concat(line);
          poemContent.push("\n")
        })
        // console.log("poemContent: ", poemContent);

        fadeInPoem(poemContent);
      }

      // fade in action, using jQuery
      function fadeInPoem(words) {
        words.forEach(function(word, i) {
          // console.log("word = ", word, "i = ", i)
          setTimeout(function () {
            if (word == "\n") {
              span = $('<br>');
            } else {
              var span = $('<span>').text(word + " ");
            }
            $('.lines').append(span)
            span.hide();
            span.fadeIn(3000 * Math.random());
          }, i * 100);
        });
      }

    </script>
  </body>
</html>
