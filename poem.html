<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>a poem</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script defer src="https://use.fontawesome.com/releases/v5.0.1/js/all.js"></script>
    <link rel="stylesheet" type="text/css" href="css/style.css">
    <style>
      .poem {
        margin: 50px;
      }

      .poem-metadata {
        border-bottom: 1px solid;
        display: inline-block;
        /* padding-left: 10px; */
        padding-bottom: 15px;
      }

      .poem-lines {
        font-family: 'Ovo', serif;
        font-size: 2.4em;
        font-weight: bold;
      	line-height: 1.2em;
        margin-top: 40px;
      }
    </style>
  </head>

  <body>
    <div class="poem">
      <div class="poem-metadata">
        <div class="poem-title"></div>
        <div class="poem-author"></div>
      </div>
      <div class="poem-lines">
        <div class="poem-placeholder">
          <i class="fas fa-spinner fa-pulse fa-2x"></i>
        </div>
      </div>
    </div>

    <script>
      const poemTitle = document.querySelector('.poem-title');
      const poemAuthor = document.querySelector('.poem-author');
      const poemLines = document.querySelector('.poem-lines');
      const titleIndex = getRandomInt(0, 2973)

      // get random integer between 0-2997, the length of the titles
      // array in poetrybd.org
      function getRandomInt(min, max) {
        min = Math.ceil(min);
        max = Math.floor(max);
        return Math.floor(Math.random() * (max - min)) + min; //The maximum is exclusive and the minimum is inclusive
      }

      // Hacky fix: Use a CORS proxy to get around localhost
      // “No Access-Control-Allow-Origin header” problem :/
      // https://stackoverflow.com/questions/43871637/no-access-control-allow-origin-header-is-present-on-the-requested-resource-whe/43881141
      const proxyurl = "https://cors-anywhere.herokuapp.com/";

      // get a random title from poetrydb.org using a random integer (titleIndex)
      fetch(proxyurl + 'http://poetrydb.org/title')
        .then(function(response) {
          return response.json();
        })
        .then(function(data) {
          const title = data.titles[titleIndex];
          getPoem(title);
        }).catch(function(error) {
          console.log('Poem could not be fetched :', error.message);
        });

      // get poem data for a title through poetrydb.org
      function getPoem(title) {
        fetch(`${proxyurl}http://poetrydb.org/title/${title}`)
          .then(function(response) {
            return response.json();
          })
          .then(function(data) {
            displayPoem(data[0]);
          })
      }

      function displayPoem({title, author, lines}) {
        poemTitle.textContent = title;
        poemAuthor.textContent = `By ${author}`;

        // create array of poem words with line breaks at the end of each line
        let poemContent = []
        lines.forEach(line => {
          line = line.split(' ');
          poemContent = poemContent.concat(line);
          poemContent.push("\n")
        })
        fadeInPoem(poemContent);
      }

      // fade in action, using jQuery
      function fadeInPoem(words) {
        $('.poem-placeholder').hide();
        words.forEach(function(word, i) {
          setTimeout(function () {
            // Check for and insert line breaks
            if (word == "\n") {
              span = $('<br>');
            } else {
              var span = $('<span>').text(word + " ");
            }
            $('.poem-lines').append(span)
            span.hide();
            span.fadeIn(4000 * Math.random());
          }, i * 400);
        });
      }

    </script>
  </body>
</html>
